import os
import pandas as pd
import numpy as np
from sklearn.impute import KNNImputer
import warnings
warnings.filterwarnings('ignore')

INPUT_FILE = 'data/processed/master.json'
OUTPUT_FILE = 'data/processed/clean/master_clean.csv'

if not os.path.exists(INPUT_FILE):
    print(f"Error: {INPUT_FILE} not found. Run data_loader.py first.")
    exit()

df = pd.read_json(INPUT_FILE)
print(f"Loaded {len(df)} companies")

df['ticker'] = df['ticker'].astype(str)

bank_keywords = ['BANK', 'FIN', 'NBFC']
is_bank = df['ticker'].str.contains('|'.join(bank_keywords), na=False)

if 'ev_ebitda_final' in df.columns:
    df['ev_ebitda'] = df['ev_ebitda'].combine_first(df['ev_ebitda_final'])
elif 'ev_ebitda' not in df.columns:
    df['ev_ebitda'] = np.nan

ratio_cols = ['pe_ratio', 'price_to_book', 'ev_ebitda']
debt_cols = ['debt_to_equity']
cash_cols = ['free_cashflow', 'current_ratio']
growth_cols = ['revenue_growth']

meta_cols_numeric = ['market_cap', 'profit_margins', 'roe']
# Removed meta_cols_text to avoid processing errors

banks = df[is_bank].copy()
others = df[~is_bank].copy()

def clean_numeric_cols(sub_df, cols):
    for col in cols:
        if col in sub_df.columns:
            sub_df[col] = pd.to_numeric(sub_df[col], errors='coerce').fillna(sub_df[col].median())
    return sub_df

banks = clean_numeric_cols(banks, ratio_cols)
others = clean_numeric_cols(others, ratio_cols)

for col in debt_cols:
    if col in banks.columns:
        banks[col] = pd.to_numeric(banks[col], errors='coerce').fillna(banks[col].median()).fillna(200.0)
    if col in others.columns:
        others[col] = pd.to_numeric(others[col], errors='coerce').fillna(others[col].median())

numeric_groups = cash_cols + growth_cols + meta_cols_numeric
banks = clean_numeric_cols(banks, numeric_groups)
others = clean_numeric_cols(others, numeric_groups)

merged = pd.concat([banks, others], axis=0).reset_index(drop=True)

numeric_targets = ratio_cols + debt_cols + cash_cols + growth_cols + meta_cols_numeric + ['total_debt', 'enterprise_value', 'ebitda']

for c in numeric_targets:
    if c in merged.columns:
        merged[c] = pd.to_numeric(merged[c], errors='coerce')

imputer_cols = [c for c in numeric_targets if c in merged.columns and merged[c].notna().sum() > 3]

if len(imputer_cols) > 0 and len(merged) > 5:
    imputer = KNNImputer(n_neighbors=min(5, len(merged)//2))
    imputed_array = imputer.fit_transform(merged[imputer_cols])
    for i, col in enumerate(imputer_cols):
        merged[col] = imputed_array[:, i]

merged['imputed_count'] = 0
if len(imputer_cols) > 0:
    for col in imputer_cols:
        merged['imputed_count'] += merged[col].isna()

merged = merged[merged['imputed_count'] <= 4].copy()
merged.reset_index(drop=True, inplace=True)

merged['net_debt'] = merged.get('total_debt', 0).fillna(0) - merged.get('free_cashflow', 0).fillna(0)

has_ebitda = 'ebitda' in merged.columns
has_ev = 'enterprise_value' in merged.columns

if has_ev and has_ebitda:
    merged['ev_over_ebitda_calc'] = np.where(
        (merged['ebitda'].notna()) & (merged['ebitda'] != 0),
        merged['enterprise_value'] / merged['ebitda'], np.nan
    )
    merged['ev_ebitda'] = merged['ev_ebitda'].fillna(merged['ev_over_ebitda_calc'])

# --- FIX 1: Robust Scoring using Percentile Ranks ---
# Instead of clip, we rank them. Top 10% get 0.9, Bottom 10% get 0.1.
merged['earnings_quality'] = (
    merged['profit_margins'].rank(pct=True) * 0.5 + 
    merged['roe'].rank(pct=True) * 0.5
)

quality_stocks = merged[merged['earnings_quality'] > 0.1].copy()

if not quality_stocks.empty:
    # Value Score: Lower P/E is better -> Rank ascending=False
    quality_stocks['value_score'] = (
        quality_stocks['pe_ratio'].rank(pct=True, ascending=False) * 0.4 +
        quality_stocks['price_to_book'].rank(pct=True, ascending=False) * 0.3 +
        quality_stocks['ev_ebitda'].rank(pct=True, ascending=False) * 0.3
    )

    # Health Score: Lower Debt is better
    quality_stocks['health_score'] = (
        quality_stocks['debt_to_equity'].rank(pct=True, ascending=False) * 0.4 +
        quality_stocks['current_ratio'].rank(pct=True) * 0.3
    )

    # Growth Score: Higher is better
    quality_stocks['growth_score'] = (
        quality_stocks['revenue_growth'].rank(pct=True) * 0.4 +
        quality_stocks['profit_margins'].rank(pct=True) * 0.4 +
        quality_stocks['roe'].rank(pct=True) * 0.2
    )

    merged.loc[quality_stocks.index, ['value_score', 'health_score', 'growth_score']] = quality_stocks[['value_score', 'health_score', 'growth_score']].values

os.makedirs('data/processed/clean', exist_ok=True)
if 'news_text' in merged.columns:
    merged['news_text'] = merged['news_text'].astype(str).replace('nan', '')
else:
    merged['news_text'] = ""

merged.to_csv(OUTPUT_FILE, index=False)
merged.to_json('data/processed/clean/master_clean.json', indent=2, orient='records')

print(f"Processed: {len(merged)} companies")
print(f"Saved clean data to {OUTPUT_FILE}")